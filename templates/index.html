<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Adaptive Threat — Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body { padding:18px; background:#f6f7fb; color:#0f172a; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
      .card { box-shadow: 0 6px 18px rgba(16,24,40,0.06); border-radius: 12px; border: 1px solid rgba(15,23,42,0.04); background: #fff; }
      .header-title { font-weight:700; font-size:1.25rem; color:#0b1220; }
      .small-muted { color:#6b7280; font-size:0.85rem; }
      .btn-outline-logout { border-color:#e2e8f0; color:#374151; background:#fff; }
      .table thead th { background:#f8fafc; color:#374151; }
    </style>
  </head>
  <body>
    <div class="container-fluid">

      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4" style="padding-bottom:12px;">
        <div>
          <div class="header-title">Adaptive Threat Detection and Response System — Dashboard</div>
          <div class="small-muted">Monitoring console</div>
        </div>

        <div class="d-flex align-items-center gap-3">
          <div class="small-muted">Signed in as: <strong>{{ session.get('username') }}</strong></div>
          <form method="get" action="/logout" style="margin:0;">
            <button class="btn btn-sm btn-outline-logout">Logout</button>
          </form>
        </div>
      </div>

      <div class="row g-3">
        <div class="col-lg-8">
          <div class="card p-3 mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div>
                <strong id="total">0</strong>
                <div class="small-muted">Total alerts</div>
              </div>
              <div style="min-width:160px;">
                <select id="typeFilter" class="form-select form-select-sm">
                  <option value="">All types</option>
                  <option value="brute_force">Brute force</option>
                  <option value="port_scan">Port scan</option>
                </select>
              </div>
            </div>
            <canvas id="chart" height="140"></canvas>
          </div>

          <div class="card p-3">
            <div class="d-flex mb-2 gap-2">
              <input id="ipSearch" class="form-control form-control-sm" placeholder="Search IP (partial allowed)">
              <button id="apply" class="btn btn-primary btn-sm">Apply</button>
              <button id="clear" class="btn btn-outline-secondary btn-sm">Clear</button>
            </div>
            <div style="max-height:420px; overflow:auto;">
              <table class="table table-sm">
                <thead>
                  <tr><th>Time</th><th>Type</th><th>IP</th><th>Details</th></tr>
                </thead>
                <tbody id="tbody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card p-3 mb-3">
            <h6>Quick actions</h6>
            <p class="small-muted">Simulate or post a test alert</p>
            <form id="testForm" class="row g-2">
              <div class="col-12">
                <input id="testIp" class="form-control form-control-sm" placeholder="203.0.113.55" value="203.0.113.55">
              </div>
              <div class="col-12">
                <select id="testType" class="form-select form-select-sm">
                  <option value="test">test</option>
                  <option value="brute_force">brute_force</option>
                  <option value="port_scan">port_scan</option>
                </select>
              </div>
              <div class="col-12">
                <button class="btn btn-success btn-sm w-100" type="submit">Send test alert</button>
              </div>
            </form>
          </div>

          <div class="card p-3">
            <h6>Info</h6>
            <p class="small-muted mb-0">Set <code>AUTO_BLOCK=0</code> for safe testing. To enable blocking later, set <code>AUTO_BLOCK=1</code> and run elevated (admin).</p>
          </div>
        </div>
      </div>
    </div>

<script>
const API = "/api/alerts";
let chart = null;

function formatRow(a) {
  const time = a.timestamp || '';
  const type = a.alert || a.type || 'unknown';
  const ip = a.ip || '';
  const details = a.ports ? ("ports: " + a.ports) : (a.count ? ("count: " + a.count) : (a.details || ''));
  return `<tr><td>${time}</td><td>${type}</td><td>${ip}</td><td>${details}</td></tr>`;
}

async function fetchAlerts() {
  const typeFilter = document.getElementById('typeFilter').value;
  const ipFilter = document.getElementById('ipSearch').value.trim();
  const qs = new URLSearchParams();
  if (typeFilter) qs.set('type', typeFilter);
  if (ipFilter) qs.set('ip', ipFilter);
  const res = await fetch(API + (qs.toString() ? ("?"+qs.toString()) : ""));
  const j = await res.json();
  return j.alerts || [];
}

function buildChartData(alerts) {
  const now = Date.now();
  const buckets = {};
  const types = new Set();
  alerts.forEach(a => {
    const ts = new Date(a.timestamp).getTime ? new Date(a.timestamp).getTime() : now;
    const minute = Math.floor(ts / 60000) * 60000;
    const t = a.alert || 'unknown';
    types.add(t);
    buckets[minute] = buckets[minute] || {};
    buckets[minute][t] = (buckets[minute][t] || 0) + 1;
  });
  const sortedKeys = Object.keys(buckets).map(Number).sort();
  const labels = sortedKeys.map(k => new Date(k).toLocaleTimeString());
  const datasets = [];
  Array.from(types).forEach((t, idx) => {
    datasets.push({
      label: t,
      data: sortedKeys.map(k => buckets[k][t] || 0),
      fill: false,
      tension: 0.2,
    });
  });
  return { labels, datasets };
}

async function refresh() {
  const alerts = await fetchAlerts();
  document.getElementById('total').innerText = alerts.length;
  document.getElementById('tbody').innerHTML = alerts.map(a => formatRow(a)).join('');
  const cd = buildChartData(alerts);
  if (!chart) {
    const ctx = document.getElementById('chart').getContext('2d');
    chart = new Chart(ctx, {
      type: 'line',
      data: { labels: cd.labels, datasets: cd.datasets },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });
  } else {
    chart.data.labels = cd.labels;
    chart.data.datasets = cd.datasets;
    chart.update();
  }
}

document.getElementById('apply').addEventListener('click', () => refresh());
document.getElementById('clear').addEventListener('click', () => { document.getElementById('ipSearch').value = ''; document.getElementById('typeFilter').value = ''; refresh(); });
document.getElementById('testForm').addEventListener('submit', async (ev) => {
  ev.preventDefault();
  const ip = document.getElementById('testIp').value;
  const t = document.getElementById('testType').value;
  await fetch('/alert', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ alert: t, ip: ip, timestamp: new Date().toISOString(), details: 'manual test' })
  });
  refresh();
});

refresh();
setInterval(() => refresh(), 3000);
</script>
  </body>
</html>
